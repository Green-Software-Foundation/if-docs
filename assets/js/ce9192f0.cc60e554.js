"use strict";(self.webpackChunkgreen_software_training=self.webpackChunkgreen_software_training||[]).push([[8383],{4137:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>d});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=a.createContext({}),u=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},s=function(e){var t=u(e.components);return a.createElement(p.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),m=u(n),d=i,g=m["".concat(p,".").concat(d)]||m[d]||c[d]||r;return n?a.createElement(g,o(o({ref:t},s),{},{components:n})):a.createElement(g,o({ref:t},s))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var u=2;u<r;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},9283:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>l,toc:()=>u});var a=n(7462),i=(n(7294),n(4137));const r={sidebar_position:1},o="From CPU utilization to carbon emissions",l={unversionedId:"pipelines/cpu-to-carbon",id:"pipelines/cpu-to-carbon",title:"From CPU utilization to carbon emissions",description:"Tags",source:"@site/docs/pipelines/cpu-to-carbon.md",sourceDirName:"pipelines",slug:"/pipelines/cpu-to-carbon",permalink:"/pipelines/cpu-to-carbon",draft:!1,editUrl:"https://github.com/Green-Software-Foundation/if-docs/edit/master/docs/pipelines/cpu-to-carbon.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Pipeline Examples",permalink:"/pipelines/"},next:{title:"Software Carbon Intensity (SCI)",permalink:"/pipelines/sci"}},p={},u=[{value:"Tags",id:"tags",level:2},{value:"Observations",id:"observations",level:2},{value:"Impacts",id:"impacts",level:2},{value:"Scope",id:"scope",level:2},{value:"Description",id:"description",level:2},{value:"Common patterns",id:"common-patterns",level:2},{value:"Constants and coefficients:",id:"constants-and-coefficients",level:2},{value:"Assumptions and limitations",id:"assumptions-and-limitations",level:2},{value:"Components",id:"components",level:2},{value:"Plugins",id:"plugins",level:2},{value:"Interpolate",id:"interpolate",level:3},{value:"config",id:"config",level:4},{value:"Multiply",id:"multiply",level:3},{value:"config",id:"config-1",level:4},{value:"Divide",id:"divide",level:3},{value:"config",id:"config-2",level:4},{value:"IMP",id:"imp",level:2}],s={toc:u};function c(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"from-cpu-utilization-to-carbon-emissions"},"From CPU utilization to carbon emissions"),(0,i.kt)("h2",{id:"tags"},"Tags"),(0,i.kt)("p",null,"carbon, teads, power-curve"),(0,i.kt)("h2",{id:"observations"},"Observations"),(0,i.kt)("p",null,"This IMP requires the following observations:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"CPU utilization"),(0,i.kt)("li",{parentName:"ul"},"thermal design power of the processors"),(0,i.kt)("li",{parentName:"ul"},"number of vCPUs allocated to the application under observation"),(0,i.kt)("li",{parentName:"ul"},"total number of vCPUs available on the cloud instance being used"),(0,i.kt)("li",{parentName:"ul"},"the name of the cloud instance type being used"),(0,i.kt)("li",{parentName:"ul"},"the grid carbon intensity for the grid powering the data center")),(0,i.kt)("h2",{id:"impacts"},"Impacts"),(0,i.kt)("p",null,"This pipeline takes the observations described above, and generates carbon emissions in each timestep, expressed in gCO2e."),(0,i.kt)("h2",{id:"scope"},"Scope"),(0,i.kt)("p",null,"This pipeline takes into account the operational carbon of the server running our application. This includes the energy used to run the application, calculated from CPU and memory utilization. It does not account for any embodied carbon, nor networking energy, nor anything related to the end user. In real applications, the pipeline described here will be part of a much larger IMP that considers other parts of the system."),(0,i.kt)("h2",{id:"description"},"Description"),(0,i.kt)("p",null,"The Teads CPU power curve CPU utilization (as a percentage) against a scaling factor that can be applied to the CPUs thermal design power to estimate the power drawn by the CPU in Watts."),(0,i.kt)("p",null,"The research underpinning the curve was summarized in a pair of blog posts:"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://medium.com/teads-engineering/building-an-aws-ec2-carbon-emissions-dataset-3f0fd76c98ac"},"TEADS Engineering: Buildiong an AWS EC2 Carbon Emissions Dataset")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://medium.com/teads-engineering/estimating-aws-ec2-instances-power-consumption-c9745e347959"},"Teads Engineering: Estimating AWS EC2 Instances Power Consumption")),(0,i.kt)("p",null,"The curve has become very widely used as a general purpose utilization-to-wattage converter for CPUs, despite the fact that it does not generalize well."),(0,i.kt)("p",null,"The wattage can be transformed into energy by doing the following:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Measure your CPU utilization"),(0,i.kt)("li",{parentName:"ol"},"Determine the thermal design power of your processor"),(0,i.kt)("li",{parentName:"ol"},"Determine the scaling factor for your CPU utilization by interpolating the Teads curve"),(0,i.kt)("li",{parentName:"ol"},"Determine the power drawn by your CPU by multiplying your scaling factor by the CPU's thermal design power"),(0,i.kt)("li",{parentName:"ol"},"Perform a unit conversion to convert power in Watts to energy in kwH"),(0,i.kt)("li",{parentName:"ol"},"Scale the energy estimated for the entire chip to the portion of the chip that is actually in use.")),(0,i.kt)("p",null,"These steps can be executed in IF using just three plugins:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Interpolate")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Multiply")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Divide"))),(0,i.kt)("h2",{id:"common-patterns"},"Common patterns"),(0,i.kt)("p",null,"The logical flow from CPU utilization to carbon via a power-curve and thermal design power is a common pattern that is likely to be re-used elsewhere."),(0,i.kt)("h2",{id:"constants-and-coefficients"},"Constants and coefficients:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"parameter"),(0,i.kt)("th",{parentName:"tr",align:null},"description"),(0,i.kt)("th",{parentName:"tr",align:null},"value"),(0,i.kt)("th",{parentName:"tr",align:null},"unit"),(0,i.kt)("th",{parentName:"tr",align:null},"source"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"x"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"y")),(0,i.kt)("td",{parentName:"tr",align:null},"Points on power curve relating CPU utilization to a coefficient used to scale the processor's thermal design power"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"x: [0, 10, 50, 100], y: [0.12, 0.32, 0.75, 1.02]")),(0,i.kt)("td",{parentName:"tr",align:null},"dimensionless"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"https://medium.com/teads-engineering/building-an-aws-ec2-carbon-emissions-dataset-3f0fd76c98ac"},"Davy, 2021"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"grid-carbon-intensity")),(0,i.kt)("td",{parentName:"tr",align:null},"the carbon emitted per unit energy from the electrical grid"),(0,i.kt)("td",{parentName:"tr",align:null},"750"),(0,i.kt)("td",{parentName:"tr",align:null},"gCO2e/kWh"),(0,i.kt)("td",{parentName:"tr",align:null},"approximates global average")))),(0,i.kt)("h2",{id:"assumptions-and-limitations"},"Assumptions and limitations"),(0,i.kt)("p",null,"The following are assumed to be true in this IMP:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"the power curve relating CPU utilization to power is appropriate for the processor being used to run our application"),(0,i.kt)("li",{parentName:"ul"},"the temporal granularity of the observations are sufficient to accurately capture the behaviour of our application"),(0,i.kt)("li",{parentName:"ul"},"the grid carbon intensity is sufficiently accurate for the location where the computational work is done")),(0,i.kt)("h2",{id:"components"},"Components"),(0,i.kt)("p",null,"There is only one component in this example. It represents the entire application. The component pipeline looks as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"pipeline:\n  compute:\n    - interpolate\n    - cpu-factor-to-wattage\n    - wattage-times-duration\n    - wattage-to-energy-kwh\n    - calculate-vcpu-ratio\n    - correct-cpu-energy-for-vcpu-ratio\n    - energy-to-carbon\n")),(0,i.kt)("h2",{id:"plugins"},"Plugins"),(0,i.kt)("h3",{id:"interpolate"},"Interpolate"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"interpolate")," plugin is used once. The instance is named ",(0,i.kt)("inlineCode",{parentName:"p"},"interpolate"),". It is used to interpolate the curve relating CPU utilization and thermal-design-power factor so that the right value can be retrieved for the observed CPU utilization at each timestep."),(0,i.kt)("h4",{id:"config"},"config"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"method: linear\nx: [0, 10, 50, 100]\ny: [0.12, 0.32, 0.75, 1.02]\ninput-parameter: cpu/utilization\noutput-parameter: cpu-factor\n")),(0,i.kt)("h3",{id:"multiply"},"Multiply"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Multiply")," plugin is used several times. The instances are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"cpu-factor-to-wattage"),": used to multiply the thermal design power of the processor by the factor returned from the power curve interpolation, yielding power in Watts."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"wattage-times-duration"),": used to multiply the power in Watts by the duration of each timestep, yielding energy in W/duration."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"energy-to-carbon"),": used to convert energy expended to carbon emitted.")),(0,i.kt)("h4",{id:"config-1"},"config"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"cpu-factor-to-wattage:\n  input-parameters:\n    - cpu-factor\n    - cpu/thermal-design-power\n  output-parameter:\n    - cpu-wattage\n\nwattage-times-duration:\n  input-parameters:\n    - cpu-wattage\n    - duration\n  output-parameter:\n    - cpu-wattage-times-duration\n\nenergy-to-carbon:\n  input-parameters:\n    - grid-carbon-intensity\n    - energy-cpu-kwh\n  output-parameter:\n    - carbon\n")),(0,i.kt)("h3",{id:"divide"},"Divide"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Divide")," plugin is used several times in this IMP. The instances are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"wattage-to-energy-kwh"),". used to convert energy in W/duration to kWh."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"calculate-vcpu-ratio"),": used to calculate the ratio of allocated vCPUs to total vCPUS"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"correct-cpu-energy-for-vcpu-ratio"),": used to scale the CPU energy by the vCPU ratio")),(0,i.kt)("h4",{id:"config-2"},"config"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"wattage-to-energy-kwh:\n  numerator: cpu-wattage-times-duration\n  denominator: 3600000\n  output: cpu-energy-raw\n\ncalculate-vcpu-ratio:\n  numerator: vcpus-total\n  denominator: vcpus-allocated\n  output: vcpu-ratio\n\ncorrect-cpu-energy-for-vcpu-ratio:\n  numerator: cpu-energy-raw\n  denominator: vcpu-ratio\n  output: cpu/energy\n")),(0,i.kt)("h2",{id:"imp"},"IMP"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"name: teads curve demo\ndescription:\ntags:\ninitialize:\n  plugins:\n    interpolate:\n      path: builtin\n      method: Interpolation\n      config:\n        method: linear\n        x:\n          - 0\n          - 10\n          - 50\n          - 100\n        'y':\n          - 0.12\n          - 0.32\n          - 0.75\n          - 1.02\n        input-parameter: cpu/utilization\n        output-parameter: cpu-factor\n    cpu-factor-to-wattage:\n      path: builtin\n      method: Multiply\n      config:\n        input-parameters:\n          - cpu-factor\n          - thermal-design-power\n        output-parameter: cpu-wattage\n    wattage-times-duration:\n      path: builtin\n      method: Multiply\n      config:\n        input-parameters:\n          - cpu-wattage\n          - duration\n        output-parameter: cpu-wattage-times-duration\n    wattage-to-energy-kwh:\n      path: builtin\n      method: Divide\n      config:\n        numerator: cpu-wattage-times-duration\n        denominator: 3600000\n        output: cpu-energy-raw\n    calculate-vcpu-ratio:\n      path: builtin\n      method: Divide\n      config:\n        numerator: vcpus-total\n        denominator: vcpus-allocated\n        output: vcpu-ratio\n    correct-cpu-energy-for-vcpu-ratio:\n      path: builtin\n      method: Divide\n      config:\n        numerator: cpu-energy-raw\n        denominator: vcpu-ratio\n        output: cpu-energy-kwh\n    energy-to-carbon:\n      path: builtin\n      method: Multiply\n      config:\n        input-parameters:\n          - grid-carbon-intensity\n          - cpu-energy-kwh\n        output-parameter: carbon\nexecution:\n  command: >-\n    /home/user/.npm/_npx/1bf7c3c15bf47d04/node_modules/.bin/ts-node\n    /home/user/if/src/index.ts -m IMPs/examples/teads-curve.yml\n  environment:\n    if-version: 0.6.0\n    os: macOS\n    os-version: 14.6.1\n    node-version: 18.20.4\n    date-time: 2024-10-03T15:11:48.498Z (UTC)\n    dependencies:\n      - '@babel/core@7.22.10'\n      - '@babel/preset-typescript@7.23.3'\n      - '@commitlint/cli@18.6.0'\n      - '@commitlint/config-conventional@18.6.0'\n      - '@grnsft/if-core@0.0.25'\n      - '@jest/globals@29.7.0'\n      - '@types/jest@29.5.8'\n      - '@types/js-yaml@4.0.9'\n      - '@types/luxon@3.4.2'\n      - '@types/node@20.9.0'\n      - axios-mock-adapter@1.22.0\n      - axios@1.7.2\n      - cross-env@7.0.3\n      - csv-parse@5.5.6\n      - csv-stringify@6.4.6\n      - fixpack@4.0.0\n      - gts@5.2.0\n      - husky@8.0.3\n      - jest@29.7.0\n      - js-yaml@4.1.0\n      - lint-staged@15.2.2\n      - luxon@3.4.4\n      - release-it@16.3.0\n      - rimraf@5.0.5\n      - ts-command-line-args@2.5.1\n      - ts-jest@29.1.1\n      - typescript-cubic-spline@1.0.1\n      - typescript@5.2.2\n      - winston@3.11.0\n      - zod@3.23.8\n  status: success\ntree:\n  children:\n    child:\n      pipeline:\n        observe:\n        regroup:\n        compute:\n          - interpolate\n          - cpu-factor-to-wattage\n          - wattage-times-duration\n          - wattage-to-energy-kwh\n          - calculate-vcpu-ratio\n          - correct-cpu-energy-for-vcpu-ratio\n          - energy-to-carbon\n      defaults:\n        thermal-design-power: 100\n        vcpus-total: 8\n        vcpus-allocated: 2\n        grid-carbon-intensity: 750\n      inputs:\n        - timestamp: 2023-08-06T00:00\n          duration: 360\n          cpu/utilization: 1\n          carbon: 30\n        - timestamp: 2023-09-06T00:00\n          duration: 360\n          carbon: 30\n          cpu/utilization: 10\n        - timestamp: 2023-10-06T00:00\n          duration: 360\n          carbon: 30\n          cpu/utilization: 50\n        - timestamp: 2023-10-06T00:00\n          duration: 360\n          carbon: 30\n          cpu/utilization: 100\n      outputs:\n        - timestamp: 2023-08-06T00:00\n          duration: 360\n          cpu/utilization: 1\n          carbon: 30\n          thermal-design-power: 100\n          vcpus-total: 8\n          vcpus-allocated: 2\n          grid-carbon-intensity: 750\n          cpu-factor: 0.13999999999999999\n          cpu-wattage: 13.999999999999998\n          cpu-wattage-times-duration: 5039.999999999999\n          cpu-energy-raw: 0.0013999999999999998\n          vcpu-ratio: 4\n          cpu-energy-kwh: 0.00034999999999999994\n        - timestamp: 2023-09-06T00:00\n          duration: 360\n          carbon: 30\n          cpu/utilization: 10\n          thermal-design-power: 100\n          vcpus-total: 8\n          vcpus-allocated: 2\n          grid-carbon-intensity: 750\n          cpu-factor: 0.32\n          cpu-wattage: 32\n          cpu-wattage-times-duration: 11520\n          cpu-energy-raw: 0.0032\n          vcpu-ratio: 4\n          cpu-energy-kwh: 0.0008\n        - timestamp: 2023-10-06T00:00\n          duration: 360\n          carbon: 30\n          cpu/utilization: 50\n          thermal-design-power: 100\n          vcpus-total: 8\n          vcpus-allocated: 2\n          grid-carbon-intensity: 750\n          cpu-factor: 0.75\n          cpu-wattage: 75\n          cpu-wattage-times-duration: 27000\n          cpu-energy-raw: 0.0075\n          vcpu-ratio: 4\n          cpu-energy-kwh: 0.001875\n        - timestamp: 2023-10-06T00:00\n          duration: 360\n          carbon: 30\n          cpu/utilization: 100\n          thermal-design-power: 100\n          vcpus-total: 8\n          vcpus-allocated: 2\n          grid-carbon-intensity: 750\n          cpu-factor: 1.02\n          cpu-wattage: 102\n          cpu-wattage-times-duration: 36720\n          cpu-energy-raw: 0.0102\n          vcpu-ratio: 4\n          cpu-energy-kwh: 0.00255\n")))}c.isMDXComponent=!0}}]);